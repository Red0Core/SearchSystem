# Что решает текущий поиск и как он устроен

## Задачи, которые система закрывает
- **Опечатки и повторные буквы.** Нормализация схлопывает повторяющиеся символы и приводит текст к нижнему регистру, чтобы `коттерьпиллор` совпадал с `caterpillar`.
- **Смешанные раскладки и латиница/кириллица.** Транслитерация приводит обе раскладки к единому ASCII-представлению (`titleTranslit`), поэтому латинские и русские запросы бьют в одно поле.
- **Брендовые синонимы и вариативные формы.** Статические замены (например, alias брендов) отрабатывают ещё на этапе нормализации, уменьшая зависимость от точного написания.
- **Фонетические совпадения.** Double Metaphone по нормализованным токенам (`titlePhonetic`, `phonetic`) позволяет находить бренды/товары с похожим звучанием, даже если текст сильно искажен.
- **Устойчивость к частичным совпадениям.** Фаззи-поиск в Elasticsearch по текстовым, транслитерированным и фонетическим полям подстраховывает пропуски и перестановки символов.

## Общая архитектура алгоритма
1. **Нормализация входа** — нижний регистр, схлопывание повторов, очистка пунктуации и применение статических синонимов брендов.
2. **Транслитерация** — превращение нормализованной строки в ASCII, чтобы латиница и кириллица индексировались в едином `titleTranslit`.
3. **Фонетика** — лёгкие диграфные замены (`sch/sh/zh/ch → ш/ж/ч`), транслитерация в латиницу и Double Metaphone для полей `titlePhonetic` и `phonetic`.
4. **Индексирование** — сохранение исходного текста, транслитерации и фонетических ключей в документе.
5. **Поисковый запрос** — один `bool` в Elasticsearch: текстовый `multi_match` с fuzziness, транслитерированный `multi_match`, фонетический `multi_match` и блок по артикулам.

## Ограничения текущего подхода
- **Нет глубокого понимания смысла.** Алгоритм работает на токенах/звуках и не учитывает семантику описаний или совместимость деталей.
- **Ограниченные синонимы.** Используются только статические списки; новые названия брендов или разговорные формы требуют ручного пополнения.
- **Морфология и склонения в зачатке.** Нет полноценного лемматизатора: редкие грамматические формы могут выпадать из матча, если их не покрывает fuzziness.
- **Сложные артикулы и составные коды.** Текущий fuzzy-блок по артикулам не раскладывает составные/иерархические коды; для них нужен отдельный анализатор или n-gram поле.
- **Отсутствие персонализации.** Рейтинг строится только на текстовых сигналах; нет сигналов поведения пользователя или бизнес-логики по поставщикам.

Эти ограничения можно постепенно снять: добавить морфологию (pymorphy, spaCy), расширить синонимы, завести n-gram поля для кодов, внедрить переранжирование на ML или правилах по поставщикам.
